<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='domain-level-BallMoveMobLeaveService'>/**
</span> * @class
 * BallMoveMobLeaveService provides the function to move ball and process field boms collectly.
 */
domain.level.BallMoveMobLeaveService = (function () {
    &#39;use strict&#39;;

<span id='domain-level-BallMoveMobLeaveService-method-constructor'>    /**
</span>     * @constructor
     * @param {domain.level.Ball} ball The ball
     * @param {Array} cells The cells
     */
    var exports = function (ball, cells) {
        this.ball = ball;
        this.mobs = new Mobs(cells);

        this.pmds = new domain.level.PossibleMoveDetectionService(this.ball, cells);
    };

    var bmsPrototype = exports.prototype;

<span id='domain-level-BallMoveMobLeaveService-method-ballMoveAndLeaveOne'>    /**
</span>     * Makes the ball move to the specified direction and a mob leave the field.
     *
     * @param {String} dir The direction the ball moves (up|down|right|left)
     * @returns {domain.level.Cell|Rx.Observable} A promise which resolves when the mob(bom) left the field
     */
    bmsPrototype.ballMoveAndLeaveOne = function (dir) {

        // position interface
        // pos.x x-coordinate
        // pos.y y-coordinate
        var pos = this.ball.posAhead(dir);

        if (this.mobs.find(pos) == null) {

            this.ball.refuseToMove(dir);

            return null;
        }

        this.ball.move(dir);

        return this.leaveAtPos(pos);

    };

<span id='domain-level-BallMoveMobLeaveService-method-leaveLastOneAtBall'>    /**
</span>     * Make the mob at the ball leave the field.
     *
     * @return {domain.level.Cell}
     */
    bmsPrototype.leaveLastOneAtBall = function () {

        return this.mobs.leave(this.ball.pos()).setLastOne();

    };

<span id='domain-level-BallMoveMobLeaveService-method-leaveAtPos'>    /**
</span>     * Make a mob at the specified position leave the field.
     *
     * @param {Object} pos The position
     * @return {domain.level.Cell|Rx.Observable}
     */
    bmsPrototype.leaveAtPos = function (pos) {

        var that = this;

        var mob = this.mobs.leave(pos);


        if (this.pmds.possible()) {

            return mob;

        }

        console.log(&#39;no more move!&#39;);

        if (this.pmds.cellRemainsAtBall()) {

            console.log(&#39;cell remains at ball&#39;);

            return [mob, wait(600).then(function () {

                return that.leaveLastOneAtBall();

            })].toFlatStream();

        }

        console.log(&#39;no cell left&#39;);

        return mob.setLastOne();

    };

<span id='domain-level-BallMoveMobLeaveService-Mobs'>    /**
</span>     * Mobs is the role class which represents the collection of cells on and below the field.
     *
     * Mobs is the adaptor class of domain.level.FieldCells class into the BallMoveMobLeaveService context.
     *
     * @class domain.level.BallMoveMobLeaveService.Mobs
     * @private
     */
    var Mobs =


<span id='domain-level-BallMoveMobLeaveService-Mobs-method-constructor'>    /**
</span>     * @constructor
     * @param {Array} cells The array of cells
     */
    function (cells) {
        this.cells = cells;
    };

    var mobsPrototype = Mobs.prototype;

<span id='domain-level-BallMoveMobLeaveService-Mobs-method-isEmpty'>    /**
</span>     * Check if the field is empty of cells.
     *
     * @return {Boolean}
     */
    mobsPrototype.isEmpty = function () {
        return this.cells.isEmpty();
    };

<span id='domain-level-BallMoveMobLeaveService-Mobs-method-leave'>    /**
</span>     * Makes the cell at the position leave the field.
     *
     * @param {Object} pos The position
     */
    mobsPrototype.leave = function (pos) {
        var w = this.cells.select(pos);

        this.cells.remove(w);

        w = w[0];

        this.cells.selectRange(pos).forEach(function (cell) {
            cell.up();
        });

        return w;
    };


<span id='domain-level-BallMoveMobLeaveService-Mobs-method-find'>    /**
</span>     * Finds the cell at the position.
     *
     * @param {Object} pos The position
     */
    mobsPrototype.find = function (pos) {
        return this.cells.find(pos);
    };

    return exports;

}());
</pre>
</body>
</html>
